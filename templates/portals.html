{% extends "base.html" %}
{% block content %}
<div class=".container-fluid table-responsive m-lg-5">
    <table id="table" class="table table-striped table-dark nowrap" style="display:none; width:100%">
        <thead>
            <tr>
                <th>Enabled</th>
                <th>Name</th>
                <th>URL</th>
                <th>MAC</th>
                <th>Proxy</th>
                <th>FFmpeg</th>
                <th>Exipres</th>
                <th></th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% if portals is not none %}
            {% for portal in portals %}
            <tr class="align-middle">
                <td>
                    <div class="form-check form-switch">
                        <input type="checkbox" class="checkbox form-check-input" onchange="editEnabled(this)"
                            data-portal="{{ portal }}" {{ "checked" if portals[portal].enabled=="true" }}>
                    </div>
                </td>
                <td>
                    <form id="{{ portal }}" action="/portal/update" method="post">
                        <input type="text" name="enabled" value="{{ portals[portal].enabled }}" hidden>
                        <input type="text" name="ffmpeg" value="{{ portals[portal].ffmpeg }}" hidden>
                        <input type="text" name="id" value="{{ portal }}" hidden>
                        <input type="text" name="name" class="form-control" style="min-width: 200px;" required
                            value="{{ portals[portal].name }}">
                    </form>
                    <form id="removeForm" action="/portal/remove" method="post">
                    </form>
                </td>
                <td>
                    <input form="{{ portal }}" type="text" name="url" class="form-control" style="min-width: 200px;"
                        required pattern="^(http|https):\/\/.*$" title="Enter a valid URL starting with 'http|s://'"
                        value="{{ portals[portal].url }}">
                </td>
                <td>
                    <input form="{{ portal }}" type="text" name="mac" class="form-control" style="min-width: 160px;"
                        required pattern="^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$" title="Enter a valid MAC address"
                        value="{{ portals[portal].mac }}">
                </td>
                <td>
                    <input form="{{ portal }}" type="text" name="proxy" class="form-control" style="min-width: 200px;"
                        onchange="editProxy(this)" pattern="^(http|https):\/\/.*$"
                        title="Enter a valid URL starting with 'http|s://'" value="{{ portals[portal].proxy }}">
                </td>
                <td>
                    <div class="form-check form-switch">
                        <input type="checkbox" name="ffmpegCheck" class="checkbox form-check-input"
                            onchange="editFFmpeg(this)" data-portal="{{ portal }}" {{ "checked" if
                            portals[portal].ffmpeg=="true" or portals[portal].proxy!="" }} {{ "disabled" if
                            portals[portal].proxy!="" }}>
                    </div>
                </td>
                <td>{{ portals[portal].expires }}</td>
                <td>
                    <button form="{{ portal }}" class="btn btn-success btn-block" title="Save"><i
                            class="fa fa-save"></i></button>
                </td>
                <td>
                    <button form="removeForm" name="id" class="btn btn-danger btn-block" title="Delete"
                        value="{{ portal }}"><i class="fa fa-trash"></i></button>
                </td>
            </tr>
            {% endfor %}
            {% endif %}
            <tr class="align-middle">
                <td>
                    <div class="form-check form-switch">
                        <input type="checkbox" class="checkbox form-check-input" onchange="editEnabled(this)"
                            data-portal="addForm" checked>
                    </div>
                </td>
                <td>
                    <form id="addForm" action="/portal/add" method="post">
                        <input type="text" name="enabled" value="true" hidden>
                        <input type="text" name="ffmpeg" value="false" hidden>
                        <input type="text" name="name" class="form-control" style="min-width: 200px;" required>
                    </form>
                </td>
                <td>
                    <input form="addForm" type="text" name="url" class="form-control" style="min-width: 200px;" required
                        pattern="^(http|https):\/\/.*$" title="Enter a valid URL starting with 'http|s://'">
                </td>
                <td>
                    <input form="addForm" type="text" name="mac" class="form-control" style="min-width: 160px;" required
                        pattern="^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$" title="Enter a valid MAC address">
                </td>
                <td>
                    <input form="addForm" type="text" name="proxy" class="form-control" style="min-width: 200px;"
                        onchange="editProxy(this)" pattern="^(http|https):\/\/.*$"
                        title="Enter a valid URL starting with 'http|s://'">
                </td>
                <td>
                    <div class="form-check form-switch">
                        <input type="checkbox" name="ffmpegCheck" class="checkbox form-check-input"
                            data-portal="addForm">
                    </div>
                </td>
                <td></td>
                <td></td>
                <td>
                    <button form="addForm" class="btn btn-success btn-block" title="Add"><i
                            class="fa fa-plus"></i></button>
                </td>
            </tr>
        </tbody>
    </table>
</div>

<script>

    function editEnabled(ele) {
        var c = ele.checked;
        var portal = ele.getAttribute('data-portal');
        var form = document.forms[portal];
        form.elements.enabled.value = c;
    }

    function editFFmpeg(ele) {
        var c = ele.checked;
        var portal = ele.getAttribute('data-portal');
        var form = document.forms[portal];
        form.elements.ffmpeg.value = c;
    }

    function editProxy(ele) {
        var row = ele.parentElement.parentElement;
        var proxy = row.querySelector('input[name="proxy"]').value;
        var ffmpeg = row.querySelector('input[name="ffmpeg"]');
        var ffmpegCheck = row.querySelector('input[name="ffmpegCheck"]');
        if (proxy !== "") {
            ffmpegCheck.checked = true
            ffmpegCheck.disabled = true;
            ffmpeg.value = "true"
        }
        else
            ffmpegCheck.disabled = false;
    }

    $(document).ready(function () {
        var table = $('#table').DataTable({
            dom: "<'row'<'col-12'tr>>",
            ordering: false,
            paging: false,
            bFilter: false,
            bInfo: false,
        });
        $('#table').show();
    });
</script>
{% endblock %}